<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>로그인 - 영국 마법부 포털</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="page-header">
    <div class="container">
      <a class="logo" href="index.html">← 포털 홈으로</a>
      <h1>로그인</h1>
      <p>이미 등록된 마법사와 마녀를 위한 로그인 페이지입니다.</p>
    </div>
  </header>

  <main class="container narrow">
    <form class="form-card" id="login-form" novalidate>
      <label for="login-id">아이디</label>
      <input id="login-id" type="text" name="id" placeholder="마법부 아이디" required autocomplete="username">

      <label for="login-password">비밀번호</label>
      <input id="login-password" type="password" name="password" placeholder="비밀번호" required autocomplete="current-password">

      <button type="submit" class="button primary">로그인</button>
      <p class="form-note">계정이 없으신가요? <a href="signup.html">회원가입</a></p>
      <p class="error-message" id="login-error" aria-live="polite" hidden></p>
    </form>

    <section class="list-section" aria-live="polite">
      <h2>등록된 마법부 아이디</h2>
      <p class="list-help">회원가입이 완료된 계정만 로그인할 수 있습니다.</p>
      <p class="list-help" id="login-registered-empty" hidden>아직 등록된 아이디가 없습니다.</p>
      <ul class="user-list" id="login-user-list"></ul>
    </section>

    <section class="list-section" aria-live="polite">
      <h2>최근 로그인한 아이디</h2>
      <p class="list-help">실제로 로그인에 성공한 아이디 목록입니다.</p>
      <p class="list-help" id="login-history-empty" hidden>아직 로그인한 기록이 없습니다.</p>
      <ul class="user-list" id="login-history-list"></ul>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>© 2024 영국 마법부. 마법부 정보 보안국에 의해 보호됩니다.</p>
    </div>
  </footer>

  <script>
    const LOGIN_HISTORY_KEY = 'ministryLoginHistory';
    const CURRENT_USER_KEY = 'ministryCurrentUser';
    const AUTH_TOKEN_KEY = 'ministryAuthToken';

    const form = document.getElementById('login-form');
    const errorMessage = document.getElementById('login-error');
    const loginIdInput = document.getElementById('login-id');
    const loginPasswordInput = document.getElementById('login-password');

    const registeredList = document.getElementById('login-user-list');
    const registeredEmpty = document.getElementById('login-registered-empty');
    const historyList = document.getElementById('login-history-list');
    const historyEmpty = document.getElementById('login-history-empty');
    const registeredEmptyDefault = registeredEmpty.textContent;

    const loadHistory = () => {
      try {
        return JSON.parse(localStorage.getItem(LOGIN_HISTORY_KEY)) || [];
      } catch (error) {
        console.error('로그인 기록을 불러올 수 없습니다.', error);
        return [];
      }
    };

    const saveHistory = history => {
      localStorage.setItem(LOGIN_HISTORY_KEY, JSON.stringify(history));
    };

    const renderRegistered = async () => {
      registeredList.innerHTML = '';
      registeredEmpty.hidden = true;
      registeredEmpty.textContent = registeredEmptyDefault;

      try {
        const response = await fetch('/api/users/public');

        if (!response.ok) {
          throw new Error('사용자 목록을 불러오지 못했습니다.');
        }

        const users = await response.json();

        if (!users.length) {
          registeredEmpty.textContent = registeredEmptyDefault;
          registeredEmpty.hidden = false;
          return;
        }

        users.forEach(({ id }, index) => {
          const item = document.createElement('li');
          const name = document.createElement('strong');
          name.textContent = id;

          const order = document.createElement('span');
          order.textContent = `#${String(index + 1).padStart(2, '0')}`;

          item.append(name, order);
          registeredList.appendChild(item);
        });
      } catch (error) {
        console.error(error);
        registeredEmpty.textContent = '등록된 아이디 목록을 불러오지 못했습니다.';
        registeredEmpty.hidden = false;
      }
    };

    const renderHistory = () => {
      const history = loadHistory();
      historyList.innerHTML = '';

      if (!history.length) {
        historyEmpty.hidden = false;
        return;
      }

      historyEmpty.hidden = true;

      history.forEach((id, index) => {
        const item = document.createElement('li');
        const name = document.createElement('strong');
        name.textContent = id;

        const label = document.createElement('span');
        label.textContent = index === 0 ? '최근 로그인' : `기록 ${index + 1}`;

        item.append(name, label);
        historyList.appendChild(item);
      });
    };

    form.addEventListener('submit', async event => {
      event.preventDefault();
      errorMessage.hidden = true;

      const id = loginIdInput.value.trim();
      const password = loginPasswordInput.value.trim();

      if (!id || !password) {
        errorMessage.textContent = '아이디와 비밀번호를 모두 입력해주세요.';
        errorMessage.hidden = false;
        return;
      }

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, password })
        });

        if (!response.ok) {
          const payload = await response.json().catch(() => ({}));
          errorMessage.textContent = payload.error || '아이디 또는 비밀번호가 올바르지 않습니다.';
          errorMessage.hidden = false;
          return;
        }

        const payload = await response.json();
        const { token, user } = payload;
        const history = loadHistory();
        const userId = user?.id || id;
        const filteredHistory = history.filter(entry => entry !== userId);
        filteredHistory.unshift(userId);
        saveHistory(filteredHistory);

        localStorage.setItem(CURRENT_USER_KEY, userId);
        localStorage.setItem(AUTH_TOKEN_KEY, token);
        localStorage.setItem('ministryCurrentRole', user?.role || 'user');

        renderHistory();
        window.location.href = 'login-success.html';
      } catch (error) {
        console.error('login failed', error);
        errorMessage.textContent = '서버에 연결하지 못했습니다. 잠시 후 다시 시도해주세요.';
        errorMessage.hidden = false;
      }
    });

    renderRegistered();
    renderHistory();
  </script>
</body>
</html>
