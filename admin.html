<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>비밀 관리자실 - 영국 마법부 포털</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="page-header">
    <div class="container">
      <a class="logo" href="index.html">← 일반 포털로 돌아가기</a>
      <h1>비밀 관리자실</h1>
      <p>권한이 부여된 보안 담당자만 접근 가능한 마법부 기록실입니다.</p>
    </div>
  </header>

  <main class="container narrow" id="admin-root">
    <section class="form-card" id="admin-lock">
      <h2>보안 해제</h2>
      <p class="list-help">마법부 비밀 구문을 입력해야 민원과 회원 명부를 열람할 수 있습니다.</p>
      <form id="unlock-form" autocomplete="off">
        <label for="admin-passphrase">보안 구문</label>
        <input id="admin-passphrase" type="password" name="passphrase" placeholder="암구호를 입력하세요" required>
        <button type="submit" class="button primary">기밀 열람</button>
        <p class="error-message" id="unlock-error" aria-live="polite" hidden>암구호가 올바르지 않습니다. 다시 시도하세요.</p>
      </form>
      <p class="secret-hint">* 힌트: 포털 개발팀이 즐겨 쓰는 마법 구문을 떠올려 보세요.</p>
    </section>

    <div id="admin-content" class="admin-wrapper" hidden>
      <section class="form-card admin-panel" id="admin-actions">
        <h2>보안 데이터 열람</h2>
        <p class="list-help">관리자 권한으로 서버에 저장된 회원 목록과 민원 기록을 불러옵니다.</p>
        <div class="button-row">
          <button id="admin-refresh" class="button primary" type="button">회원/민원 보기</button>
          <a class="button" href="admin-login.html">관리자 계정으로 로그인</a>
        </div>
        <p class="error-message" id="admin-fetch-error" aria-live="polite" hidden></p>
      </section>

      <section class="list-section admin-panel" aria-live="polite">
        <h2>등록된 마법부 회원</h2>
        <p class="list-help">회원가입을 완료한 아이디와 보안 확인용 비밀번호 목록입니다.</p>
        <p class="list-help" id="admin-users-empty" hidden>아직 등록된 회원이 없습니다.</p>
        <table class="admin-table" id="admin-users-table" aria-describedby="admin-users-empty">
          <thead>
            <tr>
              <th scope="col">번호</th>
              <th scope="col">아이디</th>
              <th scope="col">비밀번호</th>
            </tr>
          </thead>
          <tbody id="admin-users-body"></tbody>
        </table>
      </section>

      <section class="list-section admin-panel" aria-live="polite">
        <h2>접수된 민원 기록</h2>
        <p class="list-help">총리에게 바란다에서 접수된 최신 민원 순입니다.</p>
        <p class="list-help" id="admin-petitions-empty" hidden>아직 접수된 민원이 없습니다.</p>
        <ul class="petition-list admin-petitions" id="admin-petitions-list"></ul>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>© 2024 영국 마법부. 허가되지 않은 접근은 기억 제거 주문의 대상이 됩니다.</p>
    </div>
  </footer>

  <script>
    const SECRET_PASSPHRASE = 'MischiefManaged!';
    const AUTH_TOKEN_KEY = 'ministryAuthToken';
    const ROLE_KEY = 'ministryCurrentRole';
    const ADMIN_SESSION_KEY = 'ministryAdminUnlocked';

    const adminLock = document.getElementById('admin-lock');
    const adminContent = document.getElementById('admin-content');
    const unlockForm = document.getElementById('unlock-form');
    const passphraseInput = document.getElementById('admin-passphrase');
    const unlockError = document.getElementById('unlock-error');

    const adminRefreshButton = document.getElementById('admin-refresh');
    const adminFetchError = document.getElementById('admin-fetch-error');
    const usersTableBody = document.getElementById('admin-users-body');
    const usersEmptyMessage = document.getElementById('admin-users-empty');
    const petitionsList = document.getElementById('admin-petitions-list');
    const petitionsEmptyMessage = document.getElementById('admin-petitions-empty');

    const createMultilineParagraph = text => {
      const paragraph = document.createElement('p');
      const lines = text.split('\n');

      lines.forEach((line, index) => {
        paragraph.append(document.createTextNode(line));

        if (index < lines.length - 1) {
          paragraph.append(document.createElement('br'));
        }
      });

      return paragraph;
    };

    const renderUsers = users => {
      usersTableBody.innerHTML = '';

      if (!users.length) {
        usersEmptyMessage.hidden = false;
        return;
      }

      usersEmptyMessage.hidden = true;

      users.forEach((user, index) => {
        const row = document.createElement('tr');

        const orderCell = document.createElement('td');
        orderCell.textContent = `#${String(index + 1).padStart(2, '0')}`;

        const idCell = document.createElement('td');
        idCell.textContent = user.id;

        const passwordCell = document.createElement('td');
        passwordCell.textContent = user.password;

        row.append(orderCell, idCell, passwordCell);
        usersTableBody.appendChild(row);
      });
    };

    const renderPetitions = petitions => {
      petitionsList.innerHTML = '';

      if (!petitions.length) {
        petitionsEmptyMessage.hidden = false;
        return;
      }

      petitionsEmptyMessage.hidden = true;

      petitions
        .sort((a, b) => new Date(b.timestamp || b.time) - new Date(a.timestamp || a.time))
        .forEach(petition => {
          const listItem = document.createElement('li');
          listItem.className = 'petition-item';

          const header = document.createElement('div');
          header.className = 'petition-header';

          const nameLabel = document.createElement('strong');
          nameLabel.textContent = petition.name;

          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = petition.topic;

          header.append(nameLabel, badge);

          const contentParagraph = createMultilineParagraph(petition.content);

          const time = document.createElement('time');
          const dateValue = petition.timestamp || petition.time;
          time.textContent = dateValue ? new Date(dateValue).toLocaleString('ko-KR') : '시간 정보 없음';

          listItem.append(header, contentParagraph, time);
          petitionsList.appendChild(listItem);
        });
    };

    const fetchAdminData = async () => {
      adminFetchError.hidden = true;

      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      const role = localStorage.getItem(ROLE_KEY);

      if (!token || role !== 'admin') {
        adminFetchError.textContent = '관리자 계정으로 로그인 후 다시 시도하세요.';
        adminFetchError.hidden = false;
        return;
      }

      try {
        const [usersResponse, petitionsResponse] = await Promise.all([
          fetch('/api/admin/users', { headers: { Authorization: `Bearer ${token}` } }),
          fetch('/api/admin/petitions', { headers: { Authorization: `Bearer ${token}` } }),
        ]);

        if ([usersResponse.status, petitionsResponse.status].some(status => status === 401 || status === 403)) {
          usersTableBody.innerHTML = '';
          petitionsList.innerHTML = '';
          usersEmptyMessage.hidden = false;
          petitionsEmptyMessage.hidden = false;
          adminFetchError.textContent = '관리자 권한이 없습니다. 관리자 계정으로 다시 로그인하세요.';
          adminFetchError.hidden = false;
          return;
        }

        if (!usersResponse.ok || !petitionsResponse.ok) {
          throw new Error('failed to fetch admin data');
        }

        const [users, petitions] = await Promise.all([
          usersResponse.json(),
          petitionsResponse.json(),
        ]);

        renderUsers(users);
        renderPetitions(petitions);
      } catch (error) {
        console.error(error);
        adminFetchError.textContent = '서버에서 데이터를 불러오지 못했습니다.';
        adminFetchError.hidden = false;
      }
    };

    const unlockAdmin = () => {
      adminLock.hidden = true;
      adminContent.hidden = false;
      if (localStorage.getItem(AUTH_TOKEN_KEY) && localStorage.getItem(ROLE_KEY) === 'admin') {
        fetchAdminData();
      }
    };

    unlockForm.addEventListener('submit', event => {
      event.preventDefault();
      const passphrase = passphraseInput.value.trim();

      if (passphrase !== SECRET_PASSPHRASE) {
        unlockError.hidden = false;
        passphraseInput.focus();
        passphraseInput.select();
        return;
      }

      unlockError.hidden = true;
      passphraseInput.value = '';
      sessionStorage.setItem(ADMIN_SESSION_KEY, 'true');
      unlockAdmin();
    });

    passphraseInput.addEventListener('input', () => {
      unlockError.hidden = true;
    });

    adminRefreshButton.addEventListener('click', fetchAdminData);

    const hasUnlocked = sessionStorage.getItem(ADMIN_SESSION_KEY) === 'true';

    if (hasUnlocked) {
      unlockAdmin();
    } else {
      adminLock.hidden = false;
      adminContent.hidden = true;
      passphraseInput.focus();
    }
  </script>
</body>
</html>
