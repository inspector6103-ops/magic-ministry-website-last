<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>로그인 완료 - 영국 마법부 포털</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="page-header">
    <div class="container">
      <a class="logo" href="index.html">← 포털 홈으로</a>
      <h1>로그인 완료</h1>
      <p>마법부 포털에 안전하게 접속되었습니다.</p>
    </div>
  </header>

  <main class="container narrow">
    <section class="form-card" aria-live="polite">
      <h2>환영합니다!</h2>
      <p><strong id="current-user">마법사</strong> 님, 로그인에 성공했습니다.</p>
      <p class="list-help">이제 민원 접수나 직업 신청 등 마법부의 다양한 서비스를 이용할 수 있습니다.</p>
      <div class="button-row">
        <a class="button primary" href="petition.html">총리에게 바란다 이동</a>
        <a class="button" href="jobs.html">직업 신청하기</a>
      </div>
    </section>

    <section class="list-section" aria-live="polite">
      <h2>등록된 마법부 아이디</h2>
      <p class="list-help">현재 포털에 등록된 구성원 목록입니다.</p>
      <p class="list-help" id="success-empty" hidden>등록된 아이디를 불러올 수 없습니다.</p>
      <ul class="user-list" id="success-user-list"></ul>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>© 2024 영국 마법부. 마법부 정보 보안국에 의해 보호됩니다.</p>
    </div>
  </footer>

  <script>
    const CURRENT_USER_KEY = 'ministryCurrentUser';
    const AUTH_TOKEN_KEY = 'ministryAuthToken';

    const currentUserLabel = document.getElementById('current-user');
    const registeredList = document.getElementById('success-user-list');
    const emptyMessage = document.getElementById('success-empty');

    const redirectToLogin = () => {
      window.location.href = 'login.html';
    };

    const renderUsers = async () => {
      registeredList.innerHTML = '';
      emptyMessage.hidden = true;

      try {
        const response = await fetch('/api/users/public');

        if (!response.ok) {
          throw new Error('사용자 목록 조회 실패');
        }

        const users = await response.json();

        if (!users.length) {
          emptyMessage.hidden = false;
          return;
        }

        users.forEach(({ id }, index) => {
          const item = document.createElement('li');
          const name = document.createElement('strong');
          name.textContent = id;

          const order = document.createElement('span');
          order.textContent = `#${String(index + 1).padStart(2, '0')}`;

          item.append(name, order);
          registeredList.appendChild(item);
        });
      } catch (error) {
        console.error(error);
        emptyMessage.textContent = '등록된 아이디를 불러오지 못했습니다.';
        emptyMessage.hidden = false;
      }
    };

    const currentUser = localStorage.getItem(CURRENT_USER_KEY);
    const token = localStorage.getItem(AUTH_TOKEN_KEY);

    if (!currentUser || !token) {
      redirectToLogin();
    } else {
      currentUserLabel.textContent = currentUser;
      renderUsers();
    }
  </script>
</body>
</html>
