<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>총리에게 바란다 - 영국 마법부 포털</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="page-header">
    <div class="container">
      <a class="logo" href="index.html">← 포털 홈으로</a>
      <h1>총리에게 바란다</h1>
      <p>마법 사회의 목소리를 전하세요. 접수된 민원은 내부 검토 후 마법부 총리에게 전달됩니다.</p>
    </div>
  </header>

  <main class="container">
    <section class="form-section">
      <form class="form-card" id="petition-form">
        <label for="petition-name">이름</label>
        <input id="petition-name" type="text" name="name" placeholder="작성자 이름" required>

        <label for="petition-topic">분류</label>
        <select id="petition-topic" name="topic" required>
          <option value="">분류 선택</option>
          <option value="안전">마법 보안 및 안전</option>
          <option value="교육">호그와트 및 교육</option>
          <option value="행정">행정 서비스 개선</option>
          <option value="노동">노동 및 근로 환경</option>
        </select>

        <label for="petition-content">민원 내용</label>
        <textarea id="petition-content" name="content" rows="6" placeholder="민원 내용을 자세히 작성해주세요." required></textarea>

        <button type="submit" class="button primary">민원 등록</button>
        <p class="error-message" id="petition-error" aria-live="polite" hidden></p>
        <p class="list-help" id="petition-auth-warning" hidden>민원 작성은 로그인 후 이용할 수 있습니다.</p>
      </form>
    </section>

    <section class="list-section">
      <h2>접수된 민원</h2>
      <p class="list-help">아래 목록은 이 단말기에 기록된 최신 민원입니다.</p>
      <p class="list-help" id="petition-empty" hidden>아직 접수된 민원이 없습니다.</p>
      <ul id="petition-list" class="petition-list" aria-live="polite"></ul>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>© 2024 영국 마법부. 마법부 기록 보관소에 의해 관리됩니다.</p>
    </div>
  </footer>

  <script>
    const AUTH_TOKEN_KEY = 'ministryAuthToken';

    const petitionForm = document.getElementById('petition-form');
    const petitionList = document.getElementById('petition-list');
    const petitionEmpty = document.getElementById('petition-empty');
    const petitionError = document.getElementById('petition-error');
    const authWarning = document.getElementById('petition-auth-warning');
    const petitionEmptyDefault = petitionEmpty.textContent;

    const getToken = () => localStorage.getItem(AUTH_TOKEN_KEY);

    const setFormDisabled = disabled => {
      Array.from(petitionForm.elements).forEach(element => {
        element.disabled = disabled;
      });
    };

    const createMultilineParagraph = text => {
      const paragraph = document.createElement('p');
      const lines = text.split('\n');

      lines.forEach((line, index) => {
        paragraph.append(document.createTextNode(line));

        if (index < lines.length - 1) {
          paragraph.append(document.createElement('br'));
        }
      });

      return paragraph;
    };

    const renderPetitions = async () => {
      petitionList.innerHTML = '';
      petitionEmpty.hidden = true;
      petitionEmpty.textContent = petitionEmptyDefault;

      const token = getToken();
      if (!token) {
        petitionEmpty.hidden = false;
        petitionEmpty.textContent = '로그인한 사용자만 민원을 조회할 수 있습니다.';
        return;
      }

      try {
        const response = await fetch('/api/petitions', {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (response.status === 401 || response.status === 403) {
          petitionEmpty.hidden = false;
          petitionEmpty.textContent = '로그인한 사용자만 민원을 조회할 수 있습니다.';
          return;
        }

        if (!response.ok) {
          throw new Error('민원 목록 조회 실패');
        }

        const petitions = await response.json();

        if (!petitions.length) {
          petitionEmpty.textContent = petitionEmptyDefault;
          petitionEmpty.hidden = false;
          return;
        }

        petitions
          .sort((a, b) => new Date(b.timestamp || b.time) - new Date(a.timestamp || a.time))
          .forEach(petition => {
            const listItem = document.createElement('li');
            listItem.className = 'petition-item';

            const header = document.createElement('div');
            header.className = 'petition-header';

            const nameLabel = document.createElement('strong');
            nameLabel.textContent = petition.name;

            const topicBadge = document.createElement('span');
            topicBadge.className = 'badge';
            topicBadge.textContent = petition.topic;

            header.append(nameLabel, topicBadge);

            const contentParagraph = createMultilineParagraph(petition.content);

            const time = document.createElement('time');
            const dateValue = petition.timestamp || petition.time;
            time.textContent = dateValue ? new Date(dateValue).toLocaleString('ko-KR') : '시간 정보 없음';

            listItem.append(header, contentParagraph, time);
            petitionList.appendChild(listItem);
          });
      } catch (error) {
        console.error(error);
        petitionEmpty.hidden = false;
        petitionEmpty.textContent = '민원 목록을 불러오지 못했습니다.';
      }
    };

    petitionForm.addEventListener('submit', async event => {
      event.preventDefault();
      petitionError.hidden = true;

      const token = getToken();

      if (!token) {
        petitionError.textContent = '로그인 후 다시 시도해주세요.';
        petitionError.hidden = false;
        return;
      }

      const name = petitionForm.name.value.trim();
      const topic = petitionForm.topic.value;
      const content = petitionForm.content.value.trim();

      if (!name || !topic || !content) {
        return;
      }

      try {
        const response = await fetch('/api/petition', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ name, topic, content })
        });

        if (!response.ok) {
          const payload = await response.json().catch(() => ({}));
          if (response.status === 401 || response.status === 403) {
            petitionError.textContent = '로그인 세션이 만료되었습니다. 다시 로그인해주세요.';
          } else {
            petitionError.textContent = payload.error || '민원을 저장하지 못했습니다.';
          }
          petitionError.hidden = false;
          return;
        }

        await renderPetitions();
        petitionForm.reset();
        petitionForm.name.focus();
      } catch (error) {
        console.error('petition submit failed', error);
        petitionError.textContent = '서버에 연결하지 못했습니다. 잠시 후 다시 시도해주세요.';
        petitionError.hidden = false;
      }
    });

    const token = getToken();
    if (!token) {
      authWarning.hidden = false;
      setFormDisabled(true);
    } else {
      authWarning.hidden = true;
      setFormDisabled(false);
    }

    renderPetitions();
  </script>
</body>
</html>
